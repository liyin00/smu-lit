<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../stylesheet/stylesheet.css">
    <link rel="stylesheet" href="../stylesheet/stylesheetSCSS.css">
    <link rel="stylesheet" href="../stylesheet/moreAnimations.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato"> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karla"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <title>Locate Advocate - Applicant Dashboard</title>
  </head>
  <body style="background-image:url(../pictures/website-bg.jpg);
  height: 100%;
  width: 100%;
  margin: 0%;
  background-repeat: no-repeat;
  background-size: cover;
  background-attachment: fixed;">

    <!--Navbar -->

    <div class="container-fluid bg-dblue">

        <header class="d-flex flex-wrap justify-content-center py-3">
          <a href="../Homepage.html" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
            <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
            <img src = "../pictures/laurels.png" style='width:50px;' class = "px-2">
            <span class="fs-4"><h1 class = "font-weight-bold text-white">Locate Advocate</h1></span>
          </a>
        </header>
    </div>
      
    <div class="d-flex bg-gold justify-content-end px-4 pt-3">
      <div>
          <nav class ="navbar">
          <p class="text-light"><u>Welcome, <span id="nameHere">!</u></span></p>
          </nav>
      </div>
    </div>

    <!--Body-->

    <div class="container p-4 px-5 mb-4">

      <div class="container-fluid">
        <!-- Section: Timeline -->
        <div class="row">
    
          <div class="col-6 col-md-6 bg-beige" style="padding: 0px;">
              <h5 class="bg-dblue text-light" style="text-align:center;">Most Recent Draft Received</h5>
              <span class = 'bg-dblue text-light m-2 px-2'>Date</span>
              <span id="case_date"></span>

              <div class="m-2 border border-secondary">
                <p class="px-1">
                  <u>Summary of facts</u><br>
                  <span id="summary_of_facts"></span>
                </p>
              </div>
              <div class="m-2 border border-secondary">
                <p class="px-1">
                  <u>Potential Issues/Legal Questions</u><br>
                  <span id="issues_questions"></span>
                </p>
              </div>
              <div class="m-2 border border-secondary">
                <p class="px-1">
                  <u>Applicable Law (Common Law topics or statues, be as specific as possible)</u><br>
                  <span id="applicable_law"></span>
                </p>
              </div>
              <div class="m-2 border border-secondary">
                <p class="px-1">
                  <u>Court Hearing the Matter</u><br>
                  <span id="court_hearing_matter"></span>
                </p>
              </div>
              <div class="m-2 border border-secondary">
                <p class="px-1">
                  <u>Any specific questions on procedure or law the applicant has</u><br>
                  <span id="specific_questions"></span>
                </p>
              </div>

          </div>
          <div class="col-1 col-md-1"></div>
          
          <!-- Section: Timeline -->
          <div class="col-5 col-md-5 bg-beige p-0 position-relative">

            <h5 class="bg-dblue text-light" style="text-align:center;">Summary Submission Log</h5>
            <section class='p-2 px-5'>
              <style>
                .timeline-with-icons {
                  border-left: 1px solid hsl(0, 0%, 90%);
                  position: relative;
                  list-style: none;
                }
    
                .timeline-with-icons .timeline-item {
                  position: relative;
                }
    
                .timeline-with-icons .timeline-item:after {
                  position: absolute;
                  display: block;
                  top: 0;
                }
    
                .timeline-with-icons .timeline-icon {
                  position: absolute;
                  left: -48px;
                  background-color: #B29E79;
                  color: #B29E79;
                  border-radius: 50%;
                  height: 31px;
                  width: 31px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                }
    
                .timeline-with-icons .timeline-current{
                    background-color: #202837;
                    color: #202837;
                    position: absolute;
                    left: -48px;
                    border-radius: 50%;
                    height: 31px;
                    width: 31px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
              </style>
    
              <ul class="timeline-with-icons" id="timeline" style="display: none;" >
                <li class="timeline-item mb-5" style="display:none;" id="latest_draft">
                  <span class="timeline-current">
                    <i class="fas fa-rocket text-primary fa-sm fa-fw"></i>
                  </span>
    
                  <h5 class="fw-bold">Latest Draft Received</h5>
                  <p class="text-muted mb-2 fw-bold" id="case_summary_date"></p>
                </li>
    
                <li class="timeline-item mb-5" style="display:none;" id="final_draft">
                  <span class="timeline-icon">
                    <i class="fas fa-users text-primary fa-sm fa-fw"></i>
                  </span>
                  <h5 class="fw-bold">Final Draft Received</h5>
                  <p class="text-muted mb-2 fw-bold" id="finalized_case_summary_date"></p>
                </li>
    
              </ul>
              <!-- <button class="border border-dark position-absolute start-50 " style="text-align: center;">Approve draft</button> -->
            </section>
            <div class="container-fluid d-flex justify-content-center" style="margin-bottom: 30px;">
              <div id="approval" style="display: none;">
                <button id="approve" class="border border-dark bg-dblue text-light mx-3" onclick="approveDraft()">Approve Latest Draft</button>
                <button id ="reqEdits" class="text-light bg-gold mx-3" style="border: none;" onclick="addEdits()">Request Edits</button>
              </div>
            </div>

            <div style="display: none;" id="request-edits">
              <h5 class="bg-dblue text-light" style="text-align:center;">Request for Edits</h5> 
              <form class="m-2">
                <div class="input-group">
                  <textarea class="form-control" aria-label="With textarea" id="client-req"></textarea>
                </div>
                <div class="container-fluid d-flex justify-content-center">
                  <button class="text-light m-3 bg-gold" style="margin-bottom: 15px; border: none;" onclick="requestEdits()">Submit Request</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const user_id = sessionStorage.getItem("userID");
      const case_id = sessionStorage.getItem("caseID");
      post_json = JSON.stringify({"case_id": case_id});
      // console.log(post_json);
      window.onload = loadDrafts();
      function loadDrafts() { 
        if(sessionStorage.getItem("userType")!="client"){
          document.getElementById("approve").style.display = "none";
          document.getElementById("reqEdits").style.display = "none";
        }
        var name = sessionStorage.getItem("name");
        document.getElementById("nameHere").innerHTML = name;
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
          let draft_info = JSON.parse(this.responseText).data;
          // console.log(draft_info.case_summary.issues_questions);

          let applicable_law = draft_info.case_summary.applicable_law;
          let case_summary_id = draft_info.case_summary.case_summary_id;
          let client_summary_feedback = draft_info.case_summary.client_summary_feedback;
          let court_hearing_matter = draft_info.case_summary.court_hearing_matter;
          let issues_questions = draft_info.case_summary.issues_questions;
          let specific_questions = draft_info.case_summary.specific_questions;
          let summary_of_facts = draft_info.case_summary.summary_of_facts;
          let case_summary_date = draft_info.case_summary_date;
          let finalised_case_summary_date = draft_info.finalised_case_summary_date;

          //logic flow for requesting edits 
          if (finalised_case_summary_date != null || case_summary_date != null) {
            // case whereby the entire case has previously been approved 
            if (case_summary_date != null && finalised_case_summary_date != null){
              document.getElementById('timeline').style.display="";
              document.getElementById('latest_draft').style.display="";
              document.getElementById('final_draft').style.display="";
              document.getElementById('case_summary_date').innerHTML = case_summary_date;
              document.getElementById('finalized_case_summary_date').innerHTML = finalised_case_summary_date;
            }
            // case whereby approval is pending 
            else if (finalised_case_summary_date == null){
              document.getElementById('timeline').style.display="";
              document.getElementById('latest_draft').style.display="";
              document.getElementById('case_summary_date').innerHTML = case_summary_date;
              document.getElementById('approval').style.display = "";
            }
          }

          //populating fields on the left 
          document.getElementById('case_date').innerHTML = case_summary_date;
          document.getElementById('summary_of_facts').innerHTML = summary_of_facts;
          document.getElementById('issues_questions').innerHTML = issues_questions;
          document.getElementById('applicable_law').innerHTML = applicable_law;
          document.getElementById('court_hearing_matter').innerHTML = court_hearing_matter;
          document.getElementById('specific_questions').innerHTML = specific_questions;
          

        }
        xhttp.open("POST", "http://52.220.49.254:8100/get_case_summary", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(post_json);
      }

      function addEdits(){
        document.getElementById('approval').style.display = "none";
        document.getElementById('request-edits').style.display = "";
      }

      function approveDraft(){
        const xhttp = new XMLHttpRequest();
        let client_summary_feedback = "";
        let client_summary_approval = "1";
        const feedback = JSON.stringify({"case_id": case_id, "client_summary_approval": client_summary_approval, "client_summary_feedback": client_summary_feedback})
        xhttp.open("POST", "http://52.220.49.254:8100/client_feedback", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(feedback);
        window.location.replace("")
      }
      function requestEdits(){ 
        const client_request = document.getElementById('client-req').value;
        const xhttp = new XMLHttpRequest();
        let client_summary_feedback = client_request;
        let client_summary_approval = "0";
        const feedback = JSON.stringify({"case_id": case_id, "client_summary_approval": client_summary_approval, "client_summary_feedback": client_request})
        xhttp.open("POST", "http://52.220.49.254:8100/client_feedback", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(feedback);
      }

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> 
  </body>
  </html>